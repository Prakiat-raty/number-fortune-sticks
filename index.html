<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>‡∏ò‡∏π‡∏õ‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß</title>
  <meta name="theme-color" content="#0b0b0f" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#0b0b0f;
      --floor:#1a1a22;
      --stick:#8b5a3c;     /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÑ‡∏°‡πâ‡∏ò‡∏π‡∏õ */
      --ash:#d9d3c8;       /* ‡∏™‡∏µ‡πÄ‡∏ñ‡πâ‡∏≤ */
      --ember:#ffcc66;     /* ‡∏™‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡πÅ‡∏î‡∏á */
      --smoke:#ffffffcc;   /* ‡∏Ñ‡∏ß‡∏±‡∏ô‡πÇ‡∏õ‡∏£‡πà‡∏á */
      --burnYpx:0px;       /* ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏´‡∏°‡πâ (px ‡∏à‡∏≤‡∏Å‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á) */
      --revealH:0%;        /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏¢‡πÄ‡∏•‡∏Ç (‡∏à‡∏≤‡∏Å‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á) */
    }
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 10%, #16161d 0%, var(--bg) 70%);}
    body{
      color:#eaeaf0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif;
      display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .wrap{
      width:min(380px, 92vw);
      display:flex; flex-direction:column; align-items:center; gap:12px;
    }
    h1{font-size:1.1rem; font-weight:700; margin:0; opacity:.9}

    .scene{
      position:relative; width:100%; aspect-ratio:3/5;
      border-radius:18px; background:linear-gradient(to bottom,#121219 0%,#0e0e14 50%,#0b0b0f 100%);
      box-shadow: 0 10px 40px rgba(0,0,0,.6) inset, 0 20px 50px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .floor{
      position:absolute; left:0; right:0; bottom:0; height:24%;
      background:radial-gradient(60% 100% at 50% 0%, #23232c 0%, var(--floor) 45%, #101018 100%);
      filter: blur(0.3px);
    }

    /* ‡πÅ‡∏ó‡πà‡∏á‡∏ò‡∏π‡∏õ */
    .incense{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:22%; width:20px; height:66%;
      display:flex; align-items:flex-start; justify-content:center;
    }
    .stick{
      position:relative; width:100%; height:100%;
      background:linear-gradient(180deg, #9a6a46 0%, var(--stick) 65%, #6f452d 100%);
      border-radius:10px;
      box-shadow:inset 0 0 0 1px #6e4732, inset 0 -6px 14px rgba(0,0,0,.35);
      overflow:hidden;
    }
    /* ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏°‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á */
    .burned{
      position:absolute; left:0; top:0; width:100%; height:var(--burnYpx);
      background:repeating-linear-gradient(180deg, #cfc8bd 0 6px, #bdb6ab 6px 12px);
      box-shadow: inset 0 -6px 10px rgba(0,0,0,.35);
      transition:height .05s linear;
    }
    /* ‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏´‡∏°‡πâ/‡∏õ‡∏•‡∏≤‡∏¢‡πÅ‡∏î‡∏á */
    .coalLine{
      position:absolute; left:-2px; width:calc(100% + 4px); height:6px;
      top:calc(var(--burnYpx) - 3px);
      background:radial-gradient(16px 6px at 50% 50%, var(--ember) 0%, #ff914d 60%, rgba(255,0,0,.25) 100%);
      filter: blur(0.5px) brightness(1.05);
      mix-blend-mode:screen;
      pointer-events:none;
    }
    /* ‡πÄ‡∏õ‡∏•‡∏ß‡πÑ‡∏ü */
    .flame{
      position:absolute; left:50%; transform:translate(-50%, 0);
      width:28px; height:44px; top:calc(var(--burnYpx) - 42px);
      pointer-events:none;
    }
    .flame::before, .flame::after{
      content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:100%; height:100%; border-radius:50% 50% 80% 80%/60% 60% 40% 40%;
      background:radial-gradient(ellipse at 50% 65%, #fff7c2 0%, #ffd36e 30%, #ff9a3d 60%, transparent 70%);
      animation: flicker 0.12s infinite alternate ease-in-out;
      filter: blur(0.4px);
    }
    .flame::after{
      width:78%; height:78%; opacity:.8; filter: blur(0.8px) brightness(1.1);
      animation-duration:.13s;
    }
    @keyframes flicker{
      from { transform:translate(-50%,-50%) scale(0.95) rotate(-2deg); }
      to   { transform:translate(-50%,-50%) scale(1.05) rotate(2deg); }
    }

    /* ‡∏Ñ‡∏ß‡∏±‡∏ô */
    .smoke{
      position:absolute; left:50%; width:8px; height:8px;
      top:calc(var(--burnYpx) - 10px); transform:translateX(-50%);
      pointer-events:none;
    }
    .puff{
      position:absolute; left:50%; top:50%; width:10px; height:10px; border-radius:50%;
      background: radial-gradient(circle at 50% 50%, var(--smoke) 0%, transparent 60%);
      animation: rise 3.8s linear infinite;
      opacity:.0; filter: blur(1.2px);
    }
    .puff:nth-child(2){ animation-delay:.9s }
    .puff:nth-child(3){ animation-delay:1.8s }
    .puff:nth-child(4){ animation-delay:2.7s }
    @keyframes rise{
      0%   { transform:translate(-50%, -10px) scale(0.6); opacity:.0 }
      10%  { opacity:.35 }
      100% { transform:translate(calc(-50% - 30px), -150px) scale(1.8); opacity:0 }
    }

    /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ß‡∏≤‡∏á‡∏ö‡∏ô‡πÅ‡∏ó‡πà‡∏á‡∏ò‡∏π‡∏õ (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ‡πÄ‡∏ú‡∏¢‡∏à‡∏≤‡∏Å‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á) */
    .digits{
      position:absolute; inset:8px 0 8px 0; display:flex; flex-direction:column;
      align-items:center; justify-content:space-between; z-index:2;
      /* ‡πÄ‡∏ú‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ö‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á var(--revealH) */
      clip-path: inset(0 0 calc(100% - var(--revealH)) 0);
      transition: clip-path .05s linear;
      pointer-events:none;
    }
    .digit{
      font-weight:800; letter-spacing:.02em;
      text-shadow: 0 1px 0 #5d3d2a, 0 2px 4px rgba(0,0,0,.4);
      /* ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏™‡∏•‡∏±‡∏Å‡∏ö‡∏ô‡πÑ‡∏°‡πâ */
      background: linear-gradient(180deg, #ffe9b9 0%, #f7d88c 40%, #d4a85f 100%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 0 0.5px #2b1b12);
      font-size: clamp(34px, 8.5vw, 42px);
      line-height: 1;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° */
    .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center }
    button{
      cursor:pointer; background:#2a2a35; color:#fff; border:1px solid #3a3a46;
      padding:10px 14px; border-radius:12px; font-weight:700; font-size:.98rem;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
    }
    button:disabled{ opacity:.55; cursor:not-allowed }
    .hint{font-size:.9rem; opacity:.75; text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>‡∏à‡∏∏‡∏î‡∏ò‡∏π‡∏õ‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß</h1>
    <div class="scene" id="scene">
      <div class="incense" id="incense">
        <div class="stick">
          <div class="burned" id="burned"></div>
          <div class="coalLine" id="coal"></div>

          <div class="digits" id="digits">
            <div class="digit" id="d1">8</div>
            <div class="digit" id="d2">8</div>
            <div class="digit" id="d3">8</div>
          </div>
        </div>
      </div>

      <div class="flame" id="flame" hidden></div>
      <div class="smoke" id="smoke" hidden>
        <div class="puff"></div>
        <div class="puff"></div>
        <div class="puff"></div>
        <div class="puff"></div>
      </div>

      <div class="floor"></div>
    </div>

    <div class="controls">
      <button id="igniteBtn">üî• ‡∏à‡∏∏‡∏î‡∏ò‡∏π‡∏õ</button>
      <button id="resetBtn" disabled>‚Ü∫ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
    </div>
    <div class="hint">‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå URL ‡πÄ‡∏ä‡πà‡∏ô <code>?num=538</code> (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ = ‡∏™‡∏∏‡πà‡∏°)</div>
  </div>

  <script>
    // ------------ (‡∏Ñ‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç/‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£/DOM ... ‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤) ------------

    // ========== ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: Spark + Crackle ==========
    let audioCtx = null;
    function ensureAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
    }

    // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏¢‡πÑ‡∏ü‡∏™‡∏±‡πâ‡∏ô ‡πÜ
    function playSpark() {
        const ctx = ensureAudio();
        const o = ctx.createOscillator();
        const g = ctx.createGain();

        o.type = 'triangle';
        o.frequency.setValueAtTime(800, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(1800, ctx.currentTime + 0.05);
        o.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.12);

        g.gain.setValueAtTime(0.0, ctx.currentTime);
        g.gain.linearRampToValueAtTime(0.6, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);

        o.connect(g); g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.16);
    }

    // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ã‡πà‡∏≤‡πÄ‡∏ö‡∏≤ ‡πÜ 0.8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    function playCrackle(duration = 0.8) {
        const ctx = ensureAudio();
        const sampleRate = ctx.sampleRate;
        const frameCount = Math.floor(sampleRate * duration);
        const buffer = ctx.createBuffer(1, frameCount, sampleRate);
        const data = buffer.getChannelData(0);

        // random noise + envelope
        for (let i = 0; i < frameCount; i++) {
        const t = i / frameCount;
        const env = Math.exp(-3 * t);        // decay ‡πÄ‡∏£‡πá‡∏ß
        const r = (Math.random() * 2 - 1);   // white noise
        data[i] = r * env * 0.4;
        }

        const source = ctx.createBufferSource();
        source.buffer = buffer;

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);

        source.connect(g).connect(ctx.destination);
        source.start();
    }

    function playIgniteSfx() {
        try { playSpark(); playCrackle(0.9); } catch(e){}
    }

    // ------------ ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏´‡∏°‡πâ layoutVars/step/ignite/resetAll ‡∏Ø‡∏•‡∏Ø) ------------
    function getTargetNumber() {
        const url = new URL(location.href);
        const s = (url.searchParams.get('num') || '').replace(/\D/g,'').slice(0,3);
        if (s.length === 3) return s;
        return String(Math.floor(100 + Math.random()*900));
    }

    const digitsEl = document.getElementById('digits');
    const d1 = document.getElementById('d1');
    const d2 = document.getElementById('d2');
    const d3 = document.getElementById('d3');
    const burned = document.getElementById('burned');
    const coal = document.getElementById('coal');
    const flame = document.getElementById('flame');
    const smoke = document.getElementById('smoke');
    const incense = document.getElementById('incense');

    const igniteBtn = document.getElementById('igniteBtn');
    const resetBtn = document.getElementById('resetBtn');

    let num = getTargetNumber();
    [d1.textContent, d2.textContent, d3.textContent] = num.split('');

    let startTime = null;
    let rafId = null;
    let running = false;

    const BURN_DURATION = 60_000;
    const REVEAL_DELAY = 1_000;

    function layoutVars(progress){
        const stick = incense.querySelector('.stick');
        const rect = stick.getBoundingClientRect();
        const H = rect.height;

        const burnYpx = Math.min(H - 2, Math.max(0, H * progress));
        const revealH = Math.max(0, (burnYpx - 8) / H * 100);
        document.documentElement.style.setProperty('--burnYpx', burnYpx + 'px');
        document.documentElement.style.setProperty('--revealH', revealH + '%');
    }

    function step(ts){
        if (!startTime) startTime = ts;
        const elapsed = ts - startTime;
        const t = Math.min(1, Math.max(0, elapsed / BURN_DURATION));
        layoutVars(t);

        if (t > 0 && t < 1){ flame.hidden = false; smoke.hidden = false; }
        else { flame.hidden = true; smoke.hidden = true; }

        if (navigator.vibrate && (elapsed > REVEAL_DELAY)){
        const stick = incense.querySelector('.stick');
        const rStick = stick.getBoundingClientRect();
        const rDigits = digitsEl.getBoundingClientRect();
        const dGap = rDigits.height / 3;
        const burnY = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--burnYpx')) || 0;
        const lineY = rStick.top + burnY;
        const centers = [0.5, 1.5, 2.5].map(i => rDigits.top + i * dGap);
        for (const c of centers){
            if (Math.abs(lineY - c) < 2.2){ navigator.vibrate?.(10); }
        }
        }

        burned.style.height = getComputedStyle(document.documentElement).getPropertyValue('--burnYpx');

        if (t < 1){ rafId = requestAnimationFrame(step); }
        else { running = false; igniteBtn.disabled = true; resetBtn.disabled = false; }
    }

    function ignite(){
        if (running) return;
        running = true;
        igniteBtn.disabled = true;
        resetBtn.disabled = true;
        startTime = null;

        // üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î
        playIgniteSfx();

        rafId = requestAnimationFrame(step);
    }

    function resetAll(){
        cancelAnimationFrame(rafId);
        running = false;
        startTime = null;
        layoutVars(0);
        burned.style.height = '0px';
        coal.style.top = '-3px';
        flame.hidden = true;
        smoke.hidden = true;

        num = getTargetNumber();
        [d1.textContent, d2.textContent, d3.textContent] = num.split('');
        igniteBtn.disabled = false;
        resetBtn.disabled = true;
    }

    window.addEventListener('resize', ()=>layoutVars(0));
    layoutVars(0);
    igniteBtn.addEventListener('click', ignite);
    resetBtn.addEventListener('click', resetAll);

    if ('serviceWorker' in navigator){
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(()=>{});
        });
    }
  </script>

</body>
</html>
